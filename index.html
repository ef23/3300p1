<html>

<head>
<title>Trump Twitter Analysis</title>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<link href="https://fonts.googleapis.com/css?family=VT323" rel="stylesheet">

<style>
h1 { font-family: 'VT323', monospace; font-size: 70px; color: rgb(8,160,233)}
body { font-family: 'Helvetica Neue', 'Arial', sans-serif;}
</style>

</head>
<body>
<h1 class="text-center"> Trump's Twitter: Analysis of a Stable Genius </h1>

<script>
/** The code for reading and formatting data */

var width = 1900;
var height = 900;
var padding = 50;
var paddingSides = 100;
var paddingBottom = 150

var vis = d3.select("body")
vis.append("svg")
.attr("width", width)
.attr("height", height);

var svg = d3.selectAll("svg")

var rawData;
var dict = {};
var sortedCounts = [];
var beforeElectionCount = 0;
var afterElectionCount = 0;

/** The X-Axis code for scale and axis */

var mindate = new Date(2015, 5, 15),
    maxdate = new Date(2018, 2, 1)

var xScale = d3.scaleTime()
    .domain([mindate, maxdate])
    .range([paddingSides, width - paddingSides]);

var xAxis = d3.axisBottom(xScale);
  svg.append("g")
  .attr("class", "xAxis")
  .attr("transform", "translate(0," + (height - paddingBottom) + ")")
  .call(xAxis
    .tickFormat(d3.timeFormat('%b'))
    .tickSize(0))
  .selectAll("text").remove()

/** The Y-Axis code for scale and axis */

var midnight = new Date();
midnight.setHours(0, 0, 0, 0);
midnight = midnight.getTime();
var dayInMill = 86400000

var yScale = d3.scaleTime()
  .domain([midnight, midnight + dayInMill - 1])
  .nice(d3.timeDay, 1)
  .rangeRound([padding, height - paddingBottom]);

var yAxis = d3.axisLeft(yScale);
  svg.append("g")
  .attr("class", "yAxis")
  .attr("transform", "translate(" + paddingSides + ", 0)")
  .call(yAxis
    .tickFormat(d3.timeFormat('%H:%M'))
    .tickSize(0)
    .tickPadding(8))

var campaignStartDay = new Date(2015, 5, 15)
var electionDay = new Date(2016, 10, 8)
var inaugrationDay = new Date(2017, 0, 21);
var y2016 = new Date(2016, 0, 1);
var y2017 = new Date(2017, 0, 1);
var y2018 = new Date(2018, 0, 1);
var oct19 = new Date(2016, 9, 19)

function drawLines(svg, height, paddingBottom, xScale, scale) {
  var importantDates = [inaugrationDay, electionDay, campaignStartDay, y2016, y2017, y2018]
  var names = ["Inaugaration Day ", "2016 Pres Election", "Campaign Begins", "2016", "2017", "2018"]

  importantDates.forEach(function(d, i){
    var isNotYear = isNaN(names[i]);

    svg.append("line")
    .attr("stroke-width", 2)
    .attr("stroke", isNotYear ? "grey" : "black")
    .attr("x1", xScale(d))
    .attr("x2", xScale(d))
    .attr("y1", height - paddingBottom)
    .attr("y2", isNotYear ? padding : height - paddingBottom + 10)

    svg.append("text")
    .attr("x", xScale(d))
    .attr("y", height - paddingBottom)
    .attr("font-size", (isNotYear ? 14 : 20) * scale)
    .text(names[i])
    .attr("transform", "rotate(-" + (isNotYear ? 90 : 45) + "," + + xScale(d) + "," + (height - paddingBottom) + ")translate(" + (isNotYear ? -125.5 : -60)*scale + "," + (isNotYear ? 2.5 : 15)*scale +  ")");

  })
}

function drawCircles(svgV, xScale, yScale, data, scale, isSmall){
  data.forEach(function(d){
    var opacity = 0.4;
    var color = "rgb(0,132,180)"
    if (isSmall){
      opacity = d.match ? 0.6 : 0.2
      color = d.match ? "#f1c40f" : color
    }

    svgV.append("circle")
    .attr("r", 5*scale)
    .attr("opacity", opacity)
    .attr("fill", color)
    .attr("cx", xScale(d.created_at))
    .attr("cy", yScale(getTime(d.created_at)))

  })
}

function getTime(date){
   return midnight +
          (date.getHours() * 60 * 60 * 1000) +
          (date.getMinutes() * 60 * 1000) +
          (date.getSeconds() * 1000);
}

d3.json("data.json", callback);

function callback(data) {
  rawData = data;
  // fix date
  rawData.forEach(function(d, i) {
    var date = d.created_at;
    d.created_at = new Date(date);

    if (d.created_at < new Date(2016, 10, 8)) {
      beforeElectionCount++;
    } else {
      afterElectionCount++;
    }

    if (i != 0) {
      var thisTime = d.created_at.getTime();
      var prevTime = rawData[i-1].created_at.getTime();
      d.next_tweet_interval = prevTime - thisTime;
    }
  })

  drawCircles(svg, xScale, yScale, rawData, 1, false);
  drawLines(svg, height, paddingBottom, xScale, 1);
  createSmallGraphs();
}

/******************************** END GRAPH 1 ****************************/

/** generates the regex that requires ALL words to be matched */
function generateRegex(str){
  return "(?=.*" + str + ")"
}

function fakenewsReg(str) {
  return "(?=.*fakenews)" + generateRegex(str)
}
var keywords = [fakenewsReg("cnn"), fakenewsReg("fox"), "^(?!.*fake news).*fox.*$", fakenewsReg("(nytimes|new york times)"), fakenewsReg("washington post"), fakenewsReg("(nbc|msnbc)"), "(dems|democrats|dnc)","fbi", "russia"]
var titles = ["CNN", "FOX and Fake News", "FOX without Fake News", "New York Times", "Washington Post", "NBC", "Democrats", "FBI", "Russia", ]

function createSmallGraphs(){
  var lowercased = rawData.map(function(d){
    d.text = d.text.toLowerCase()
    return d;
  })
  var filtered = []
  for (var keyregex in keywords) {
    filtered.push(lowercased.filter(function(d) {
      return d.text.indexOf(keyregex) !== -1
    }))
  }
  generateGraph(filtered)
}

function generateGraph(arr){
  var lwidth = 950
  var lheight = 475
  var lpadding = 25;
  var lpaddingSides = 50;
  var lpaddingBottom = 100

  arr.forEach(function(data, i) {
    var body = d3.select("body")
    body.append("svg")
    .attr("id", "svg" + i)
    .attr("width", lwidth)
    .attr("height", lheight);

    var svgLoop = d3.select("#svg" + i)

    var xLoopScale = d3.scaleTime()
        .domain([mindate, maxdate])
        .range([lpaddingSides, lwidth - lpaddingSides]);

    var xLoopAxis = d3.axisBottom(xLoopScale);
      svgLoop.append("g")
      .attr("class", "xLoopAxis")
      .attr("transform", "translate(0," + (lheight - lpaddingBottom) + ")")
      .call(xLoopAxis
        .tickFormat(d3.timeFormat('%b'))
        .tickSize(0))
      .selectAll("text").remove()

    var yLoopScale = d3.scaleTime()
      .domain([midnight, midnight + dayInMill - 1])
      .nice(d3.timeDay, 1)
      .rangeRound([lpadding, lheight - lpaddingBottom]);

    var yLoopAxis = d3.axisLeft(yLoopScale);
      svgLoop.append("g")
      .attr("class", "yLoopAxis")
      .attr("transform", "translate(" + lpaddingSides + ", 0)")
      .call(yLoopAxis
        .tickFormat(d3.timeFormat('%H:%M'))
        .tickSize(0)
        .tickPadding(8))
    drawCircles(svgLoop, xLoopScale, yLoopScale, data, .6, true);
    drawLines(svgLoop, lheight, lpaddingBottom, xLoopScale, .5);
    svgLoop.append("text")
    .attr("text-anchor", "middle")
    .attr("x", lwidth/2)
    .attr("y", 10)
    .text(titles[i]);
  })

}

</script>
</body>
</html>
