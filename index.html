<html>

<head>
<title>Trump Twitter Analysis</title>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<link href="https://fonts.googleapis.com/css?family=VT323" rel="stylesheet">

<style>
h1 { font-family: 'VT323', monospace; font-size: 70px; color: rgb(8,160,233)}
body { font-family: 'Helvetica Neue', 'Arial', sans-serif;}
</style>

</head>
<body>
<h1 class="text-center"> Twittering Day: Trump Twitter Analysis </h1>

<script>
var width = 1900;
var height = 900;
var padding = 50;
var paddingSides = 100;
var paddingBottom = 200

var vis = d3.select("body")
.append("svg")
.attr("width", width)
.attr("height", height);

var svg = d3.selectAll("svg")

/** The X-Axis code for scale and axis */

var mindate = new Date(2015, 5, 15),
    maxdate = new Date(2018, 2, 1)

var xScale = d3.scaleTime()
    .domain([mindate, maxdate])
    .range([paddingSides, width - paddingSides]);

var xAxis = d3.axisBottom(xScale);
  svg.append("g")
  .attr("class", "xAxis")
  .attr("transform", "translate(0," + (height - paddingBottom) + ")")
  .call(xAxis
    .tickFormat(d3.timeFormat('%b'))
    .tickSize(0))
  .selectAll("text").remove()

/** The Y-Axis code for scale and axis */

var midnight = new Date();
midnight.setHours(0, 0, 0, 0);
midnight = midnight.getTime();
var dayInMill = 86400000

var yScale = d3.scaleTime()
  .domain([midnight, midnight + dayInMill - 1])
  .nice(d3.timeDay, 1)
  .rangeRound([padding, height - paddingBottom]);

var yAxis = d3.axisLeft(yScale);
  svg.append("g")
  .attr("class", "yAxis")
  .attr("transform", "translate(" + paddingSides + ", 0)")
  .call(yAxis
    .tickFormat(d3.timeFormat('%H:%M'))
    .tickSize(0)
    .tickPadding(8))

/** The code for reading and formatting data */
var rawData;
var dict = {};
var sortedCounts = [];

d3.json("data.json", callback);

function callback(data) {
  rawData = data;
  // fix date
  rawData.forEach(function(d, i) {
    var date = d.created_at;
    d.created_at = new Date(date);

    if (i != 0) {
      var thisTime = d.created_at.getTime();
      var prevTime = rawData[i-1].created_at.getTime();
      d.next_tweet_interval = prevTime - thisTime;
    }
  })

  getTopIntervals();
  drawCircles();
  drawLines();
}

var campaignStartDay = new Date(2015, 5, 15)
var electionDay = new Date(2016, 10, 8)
var inaugrationDay = new Date(2017, 0, 21);
var y2016 = new Date(2016, 0, 1);
var y2017 = new Date(2017, 0, 1);
var y2018 = new Date(2018, 0, 1);


function drawLines() {
  var importantDates = [inaugrationDay, electionDay, campaignStartDay, y2016, y2017, y2018]
  var names = ["Inaugaration Day ", "2016 Pres Election", "Campaign Begins", "2016", "2017", "2018"]

  importantDates.forEach(function(d, i){
    var isNotYear = isNaN(names[i]);

    svg.append("line")
    .attr("stroke-width", 2)
    .attr("stroke", isNotYear ? "grey" : "black")
    .attr("x1", xScale(d))
    .attr("x2", xScale(d))
    .attr("y1", height - paddingBottom)
    .attr("y2", isNotYear ? padding : height - paddingBottom + 10)

    svg.append("text")
    .attr("x", xScale(d))
    .attr("y", height - paddingBottom)
    .attr("font-size", isNotYear ? 14 : 20)
    .text(names[i])
    .attr("transform", "rotate(-" + (isNotYear ? 90 : 45) + "," + + xScale(d) + "," + (height - paddingBottom) + ")translate(" + (isNotYear ? -125.5 : -60) + "," + (isNotYear ? 2.5 : 15) +  ")");

  })
}

function drawCircles(){
  var circles = svg.selectAll("circle").data(rawData);

  circles = circles
  .enter()
  .append("circle")
  .attr("r", 5)
	.attr("opacity", 0.4)
  .attr("fill", "rgb(0,132,180)")
  .merge(circles);

  circles
  .attr("cx", function(d, i ){ return xScale(d.created_at) })
  .attr("cy", function(d){ return yScale(getTime(d.created_at)) })

}

function getTime(date){
   return midnight +
          (date.getHours() * 60 * 60 * 1000) +
          (date.getMinutes() * 60 * 1000) +
          (date.getSeconds() * 1000);
}

function getTopIntervals(){
  // only get tweets within 3 min of each other
  filteredData = rawData.filter(function(d){
    return d.next_tweet_interval < dayInMill/480;
  });

  // convert to seconds
  filteredData.forEach(function(d) {
    d.next_tweet_interval = d.next_tweet_interval/1000;

    // aggregate counts/day
  if(dict[d.created_at.toDateString()]) {
    var oldResult = dict[d.created_at.toDateString()];
    dict[d.created_at.toDateString()][1].push(d)
    var newResult = [oldResult[0]+1, dict[d.created_at.toDateString()][1]]
    dict[d.created_at.toDateString()] = newResult;
  } else {
    dict[d.created_at.toDateString()] = [1, [d]]
  }
  })

  for (var count in dict) {
    sortedCounts.push([count, dict[count]]);
  }

  sortedCounts.sort(function(x, y) {
    return y[1][0] - x[1][0];
  });

  sortedCounts = sortedCounts.slice(0, 9);
}

/** time interval lol */
// var vis = d3.select("body")
// .append("svg")
// .attr("id", "svg2")
// .attr("width", width)
// .attr("height", height);

// var svg2 = d3.select("#svg2")

// /** The X-Axis code for scale and axis */

// var mindate = new Date(2017, 0, 1),
//     maxdate = new Date(2018, 1, 1)

// var xScale = d3.scaleTime()
//     .domain([mindate, maxdate])
//     .range([padding, width - padding * 2]);

// var xAxis = d3.axisBottom(xScale);
//   svg2.append("g")
//   .attr("class", "xAxis")
//   .attr("transform", "translate(0," + (height - paddingBottom) + ")")
//   .call(xAxis
//     .tickFormat(d3.timeFormat('%b')))

//  vis.selectAll(".xAxis text")
//   .attr("transform", function(d) {
//     return "translate("
//             + this.getBBox().height*-2 + ","
//             + (this.getBBox().height + 20)
//             + ")rotate(-45)";
//     })
//   .attr("font-size", 17)

/** The Y-Axis code for scale and axis */
// var filteredData;
// var dict = {}

// function drawSecondGraph() {
//   var yExtent = d3.extent(filteredData, function(d) { return d.next_tweet_interval })
//   var yScale = d3.scaleLinear()
//     .domain(yExtent)
//     .rangeRound([padding, height - padding]);

//   var yAxis = d3.axisLeft(yScale);
//     svg2.append("g")
//     .attr("class", "yAxis")
//     .attr("transform", "translate(" + padding + ", 0)")
//     .call(yAxis
//       .tickSize(0)
//       .tickPadding(8))

//   var circles = svg2.selectAll("circle").data(filteredData);

//   circles = circles
//     .enter()
//     .append("circle")
//     .attr("r", 3)
//     .attr("fill", "red")
//     .merge(circles);

//   circles
//   .attr("cx", function(d){ return xScale(d.created_at) })
//   .attr("cy", function(d){ return yScale(d.next_tweet_interval) })
// }
</script>
</body>
</html>
