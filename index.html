<html>

<head>
<title>Trump Twitter Analysis</title>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<link href="https://fonts.googleapis.com/css?family=Share+Tech+Mono" rel="stylesheet">

<style>
.right-tweet {
  float:right;
  display: inline-block;
}
.parallax {
    background-image: url("background.png");
    height: 100%;
    background-attachment: fixed;
    background-position: center;
    background-repeat: no-repeat;
    background-size: cover;
    z-index: -1;
}
h1 { font-family: 'Share Tech Mono', monospace; font-size: 40px; color: rgb(8,160,233); text-align:center; padding-top: 50px; background-color: white}
body { font-family: 'Helvetica Neue', 'Arial', sans-serif; background-color:rgb(232,245,253); margin: auto;}
svg {display:block;margin:auto;border: solid #ccc 1px;}
</style>

</head>
<body>
<div class="parallax" id="body">
<h1 class="text-center"> Trump's Twitter: Analysis of a Stable Genius </h1>
<script>
/** Regex for grabbing media stuff or other points of interest */
/** generates the regex that requires ALL words to be matched */
function generateRegex(str){
  return "(?=.*" + str + ")"
}

function fakenewsReg(str) {
  return "(?=.*(fake news|fakenews))" + generateRegex(str)
}
var keywords = [fakenewsReg("cnn"), fakenewsReg("fox"), "^(?!.*fake news).*fox.*$", fakenewsReg("(nytimes|new york times)"), fakenewsReg("washington post"), fakenewsReg("(nbc|msnbc)"), "(dems|democrats|dnc)","fbi", "russia", "immigration", "cnn", "(nbc|msnbc)", "(washington post|washingtonpost)", "(nytimes|new york times)", "obama", "fox"]
var titles = ["CNN and Fake News", "FOX and Fake News", "FOX without Fake News", "New York Times and Fake News", "Washington Post and Fake News", "NBC and Fake News", "Democrats", "FBI", "Russia", "Immigration", "CNN", "nbc", "wapo", "nyt", "Obama", "fox", "republic"]

var media = ["cnn", "nbc", "msnbc", "washington post", "washingtonpost", "wapo", "nytimes", "new york times", "fox", "media", "press", "fake news", "fakenews", "news", "journal", "reporting"]

/** The code for reading and formatting data */

var width = 1000;
var height = 500;
var padding = 50;
var paddingSides = 100;
var paddingBottom = 150

var vis = d3.select("#body")
vis.append("svg")
.attr("id", "graph1")
.attr("width", width)
.attr("height", height);

var svg = d3.selectAll("svg")
svg.append("rect")
.attr("width", width)
.attr("height", height)
.attr("x", 0)
.attr("y", 0)
.attr("fill", "white");


var rawData;
var dict = {};
var sortedCounts = [];
var beforeElectionCount = 0;
var afterElectionCount = 0;
var mediaCount = 0;
var notMediaCount = 0;

/** The X-Axis code for scale and axis */

var mindate = new Date(2015, 5, 15),
    maxdate = new Date(2018, 2, 1)

var xScale = d3.scaleTime()
    .domain([mindate, maxdate])
    .range([paddingSides, width - paddingSides]);

var xAxis = d3.axisBottom(xScale);
  svg.append("g")
  .attr("class", "xAxis")
  .attr("transform", "translate(0," + (height - paddingBottom) + ")")
  .call(xAxis
    .tickFormat(d3.timeFormat('%b'))
    .tickSize(0))
  .selectAll("text").remove()

/** The Y-Axis code for scale and axis */

var midnight = new Date();
midnight.setHours(0, 0, 0, 0);
midnight = midnight.getTime();
var dayInMill = 86400000

var yScale = d3.scaleTime()
  .domain([midnight, midnight + dayInMill - 1])
  .nice(d3.timeDay, 1)
  .rangeRound([padding, height - paddingBottom]);

var yAxis = d3.axisLeft(yScale);
  svg.append("g")
  .attr("class", "yAxis")
  .attr("transform", "translate(" + paddingSides + ", 0)")
  .call(yAxis
    .tickFormat(d3.timeFormat('%H:%M'))
    .tickSize(0)
    .tickPadding(8))

var campaignStartDay = new Date(2015, 5, 15)
var electionDay = new Date(2016, 10, 8)
var inaugurationDay = new Date(2017, 0, 21);
var y2016 = new Date(2016, 0, 1);
var y2017 = new Date(2017, 0, 1);
var y2018 = new Date(2018, 0, 1);
var oct19 = new Date(2016, 9, 19)

function drawLines(svg, height, paddingBottom, xScale, scale) {
  var importantDates = [inaugurationDay, electionDay, campaignStartDay, y2016, y2017, y2018]
  var names = ["Inauguration Day ", "2016 Pres Election", "Campaign Begins", "2016", "2017", "2018"]

  importantDates.forEach(function(d, i){
    var isNotYear = isNaN(names[i]);

    svg.append("line")
    .attr("stroke-width", 2)
    .attr("stroke", isNotYear ? "grey" : "black")
    .attr("x1", xScale(d))
    .attr("x2", xScale(d))
    .attr("y1", height - paddingBottom)
    .attr("y2", isNotYear ? padding : height - paddingBottom + 10)

    svg.append("text")
    .attr("x", xScale(d))
    .attr("y", height - paddingBottom)
    .attr("font-size", (isNotYear ? 14 : 20) * scale)
    .text(names[i])
    .attr("transform", "rotate(-" + (isNotYear ? 90 : 45) + "," + + xScale(d) + "," + (height - paddingBottom) + ")translate(" + (isNotYear ? -125.5 : -60)*scale + "," + (isNotYear ? 2.5 : 15)*scale +  ")");

  })
}

function drawCircles(svgV, xScale, yScale, data, scale, isSmall){
  data.forEach(function(d){
    //if (!d.is_media && !isSmall) return
    var opacity = 0.4;
    var color = "rgb(208, 211, 212)"
    color = d.is_media ? "rgb(40, 116, 166)" : color
		opacity = d.is_media ? 0.6 : opacity

    svgV.append("circle")
    .attr("r", 3*scale)
    .attr("opacity", opacity)
    .attr("fill", color)
    .attr("cx", xScale(d.created_at))
    .attr("cy", yScale(getTime(d.created_at)))

  })
}

function getTime(date){
   return midnight +
          (date.getHours() * 60 * 60 * 1000) +
          (date.getMinutes() * 60 * 1000) +
          (date.getSeconds() * 1000);
}

d3.json("data.json", callback);

var mediaData = '[';
var testCount = 0;

function callback(data) {
  rawData = data;
  // fix date
  rawData.forEach(function(d, i) {
    var date = d.created_at;
    d.created_at = new Date(date);
    d.is_media = false;
    for (var i = 0; i < media.length; i++) {
      var keyword = media[i];
			lowercased_text = d.text.toLowerCase();
      if(lowercased_text.includes(keyword)){
        d.is_media = true;
				mediaData += JSON.stringify(d) + ', ';
				testCount++;
        break;
      }
    }

    if (d.created_at < new Date(2016, 10, 8)) {
      beforeElectionCount++;
    } else {
      afterElectionCount++;
    }

		if (d.is_media == true) {
			mediaCount++;
		} else {
			notMediaCount++;
		}
  })


  // vis.append("img")
  // .attr("src", "https://s.faketrumptweet.com/je6oj2hi_1dqhba9_1jav0um.png")
  // .attr("class", "right-tweet")

  console.log(rawData.filter((d)=>{return d.is_media}).length)

  var beginFox = new Date();
  beginFox.setHours(6, 0, 0, 0)
  var endFox = new Date()
  endFox.setHours(9,0,0,0)
  svg.append("rect")
  .attr("x", paddingSides)
  .attr("y", yScale(getTime(beginFox)))
  .attr("height", yScale(getTime(endFox))- yScale(getTime(beginFox)))
  .attr("width", width - paddingSides*2)
  .attr("fill", "red")
  .attr("opacity", 0.4)

  svg.append("text")
  .attr("x", width - paddingSides*2)
  .attr("y", (yScale(getTime(endFox))- yScale(getTime(beginFox))))
  .text("Fox and Friends Runtime")

  svg.append("line")
  .attr("stroke-width", 3)
  .attr("stroke", "black")
  .attr("x1", width - paddingSides*1.2)
  .attr("x2", width - paddingSides)
  .attr("y1", yScale(getTime(endFox)) - ((yScale(getTime(endFox))- yScale(getTime(beginFox)))/1.5))
  .attr("y2", (yScale(getTime(endFox))- yScale(getTime(beginFox)))+10)

  drawCircles(svg, xScale, yScale, rawData, 1, false);
  drawLines(svg, height, paddingBottom, xScale, 0.8);


  // createSmallGraphs();
}
/******************************** END GRAPH 1 ****************************/
/********************************** GRAPH 2 ******************************/
// draw SVG set-up
var graph2 = d3.select("#body");
graph2.append("svg")
.attr("id","graph2")
.attr("width", width)
.attr("height", height);

var svg2 = d3.select("#graph2");
svg2.append("rect")
.attr("width", width)
.attr("height", height)
.attr("x", 0)
.attr("y", 0)
.attr("fill", "white");
/** The X-Axis code for scale and axis */

var monthScale = xScale;

var monthAxis = d3.axisBottom(monthScale);
  svg2.append("g")
  .attr("class", "xAxis")
  .attr("transform", "translate(0," + (height - paddingBottom) + ")")
  .call(monthAxis
    .tickFormat(d3.timeFormat('%B')));

/** The Y-Axis code for scale and axis */

var percentageScale = d3.scaleLinear()
  .domain([0,1])
  .rangeRound([height - paddingBottom, padding]);

var percentageAxis = d3.axisLeft(percentageScale);
  svg2.append("g")
  .attr("id", "#testAxis")
  .attr("transform", "translate(" + paddingSides + ", 0)")
  .call(percentageAxis
		.tickFormat(d3.format(".0%"))
    .tickSize(0)
    .tickPadding(8));


/******************************** END GRAPH 2 ****************************/
/********************************** GRAPH 3 ******************************/
var graph3 = d3.select("body");
graph3.append("svg")
.attr("id","graph3")
.attr("width", width)
.attr("height", height);

var svg3 = d3.select("#graph3");

svg3.append("g")
  .attr("class", "xAxis")
  .attr("transform", "translate(0," + (height - paddingBottom) + ")")
  .call(monthAxis
    .tickFormat(d3.timeFormat('%B')));
	
svg3.append("g")
  .attr("id", "#testAxis")
  .attr("transform", "translate(" + paddingSides + ", 0)")
  .call(percentageAxis
    .tickSize(0)
    .tickPadding(8));

/******************************** END GRAPH 3 ****************************/
/********************************** GRAPH 4 ******************************/
var graph4 = d3.select("body");
graph4.append("svg")
.attr("id","graph4")
.attr("width", width)
.attr("height", height);

var svg4 = d3.select("#graph4");

svg4.append("g")
  .attr("class", "xAxis")
  .attr("transform", "translate(0," + (height - paddingBottom) + ")")
  .call(monthAxis
    .tickFormat(d3.timeFormat('%B')));
	
svg4.append("g")
  .attr("id", "#testAxis")
  .attr("transform", "translate(" + paddingSides + ", 0)")
  .call(percentageAxis
    .tickSize(0)
    .tickPadding(8));


/******************************** END GRAPH 4 ****************************/
function createSmallGraphs(){
  var lowercased = rawData.map(function(d){
    d.text = d.text.toLowerCase()
    return d;
  })
  var filtered = []
  for (var i = 0; i < keywords.length; i++) {
    var regex = new RegExp(keywords[i]);
    var filter = lowercased.filter(function(d) {
      return regex.test(d.text)
    })
    var before = 0;
    var after = 0;
    filtered.push(filter)
    // filtered.push([keywords[i], before*1.0/beforeElectionCount, after*1.0/afterElectionCount])
  }
  console.log(filtered)
  generateGraph(filtered)
}

function generateGraph(arr){
  var lwidth = 950
  var lheight = 475
  var lpadding = 25;
  var lpaddingSides = 50;
  var lpaddingBottom = 100

  arr.forEach(function(data, i) {
    var body = d3.select("body")
    body.append("svg")
    .attr("id", "svg" + i)
    .attr("width", lwidth)
    .attr("height", lheight);

    var svgLoop = d3.select("#svg" + i)

    var xLoopScale = d3.scaleTime()
        .domain([mindate, maxdate])
        .range([lpaddingSides, lwidth - lpaddingSides]);

    var xLoopAxis = d3.axisBottom(xLoopScale);
      svgLoop.append("g")
      .attr("class", "xLoopAxis")
      .attr("transform", "translate(0," + (lheight - lpaddingBottom) + ")")
      .call(xLoopAxis
        .tickFormat(d3.timeFormat('%b'))
        .tickSize(0))
      .selectAll("text").remove()

    var yLoopScale = d3.scaleTime()
      .domain([midnight, midnight + dayInMill - 1])
      .nice(d3.timeDay, 1)
      .rangeRound([lpadding, lheight - lpaddingBottom]);

    var yLoopAxis = d3.axisLeft(yLoopScale);
      svgLoop.append("g")
      .attr("class", "yLoopAxis")
      .attr("transform", "translate(" + lpaddingSides + ", 0)")
      .call(yLoopAxis
        .tickFormat(d3.timeFormat('%H:%M'))
        .tickSize(0)
        .tickPadding(8))
    drawCircles(svgLoop, xLoopScale, yLoopScale, data, .6, true);
    drawLines(svgLoop, lheight, lpaddingBottom, xLoopScale, .5);
    svgLoop.append("text")
    .attr("text-anchor", "middle")
    .attr("x", lwidth/2)
    .attr("y", 10)
    .text(titles[i]);
  })

}

</script>
</div>
</body>
</html>
