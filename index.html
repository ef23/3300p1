<html>

<head>
<title>INFO3300 Project 1</title>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<link href="https://fonts.googleapis.com/css?family=Share+Tech+Mono" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300, 400,700,800|Space+Mono:400,400i,700" rel="stylesheet">

<style>
svg {display:block;margin:auto;/*border: solid #ccc 1px;*/}
img.right{position:absolute; top:0; right:0; }
h1 { font-family: 'Open Sans', sans-serif; font-weight: 800; letter-spacing: 4px; font-size: 50px; color: rgb(8,160,233); text-align:center; padding-top: 60px;}
h2 { font-family: 'Open Sans', sans-serif; font-weight: 300; font-size: 22px; text-align:center;}
h4 { font-family: 'Open Sans', sans-serif; font-weight: 800; font-size: 22px; text-align:center; margin: 0 0 0 0;}
img { width:150%; margin-top:50%; padding-right: 25%}
body { font-family: 'Space Mono: 400', monospace; /*margin: auto; */background-color:rgb(232,245,253)}
p {font-family: 'Open Sans', sans-serif; font-weight: 300; text-align:center;}
.header {padding-bottom: 50px;}
</style>

</head>
<body>
<div class="header">
  <h1 class="text-center"> TRUMP AND TWITTERING NEWS</h1>
	<h2>A look at Trump's Twitter relationship with (fake) news before and after his election <br></h2>
	<p>Team: Eric Feng, Erin Chen, Sohyeon Hwang</p>
</div>

<h4> TRUMP'S TWEETS SINCE HIS CAMPAIGN BEGAN</h4>
<div class="container-fluid">
  <div id="div1"></div>
  <h4>TWEETS CONTAINING CONTENT ABOUT MEDIA</h4>
  <div id="div2"></div>
  <h4> MENTIONED NEWS OUTLETS BY MONTH</h4>
  <div id="div3"></div>
  <h4>HOW FAKE IS THE NEWS THIS MONTH?</h4>
  <div id="div4"></div>
	<h4>TRUMP'S FAKEST MEDIA</h4>
  <div id="div5"></div>
</div>
<script>
/** Regex for grabbing media stuff or other points of interest */
/** generates the regex that requires ALL words to be matched */
function generateRegex(str){
  return "(?=.*" + str + ")"
}
function fakenewsReg(str) {
  return "(?=.*(fake news|fakenews))" + generateRegex(str)
}
var keywords = [fakenewsReg("cnn"), fakenewsReg("fox"), "^(?!.*fake news).*fox.*$", fakenewsReg("(nytimes|new york times)"), fakenewsReg("washington post"), fakenewsReg("(nbc|msnbc)"), "(dems|democrats|dnc)","fbi", "russia", "immigration", "cnn", "(nbc|msnbc)", "(washington post|washingtonpost)", "(nytimes|new york times)", "obama", "fox"]
var titles = ["CNN and Fake News", "FOX and Fake News", "FOX without Fake News", "New York Times and Fake News", "Washington Post and Fake News", "NBC and Fake News", "Democrats", "FBI", "Russia", "Immigration", "CNN", "nbc", "wapo", "nyt", "Obama", "fox", "republic"]
var media = ["cnn", "nbc", "msnbc", "washington post", "washingtonpost", "wapo", "nytimes", "new york times", "fox", "media", "press", "fake news", "fakenews", "news", "journal", "reporting"]
/** The code for reading and formatting data */
var width = 1100;
var height = 550;
var padding = 50;
var paddingSides = 200;
var paddingBottom = 150;
var linecolor = "orange";

var midnight = new Date();
midnight.setHours(0, 0, 0, 0);
midnight = midnight.getTime();
var dayInMill = 86400000

var campaignStartDay = new Date(2015, 5, 15);
var electionDay = new Date(2016, 10, 8);
var inaugurationDay = new Date(2017, 0, 21);
var y2016 = new Date(2016, 0, 1);
var y2017 = new Date(2017, 0, 1);
var y2018 = new Date(2018, 0, 1);
var mindate = new Date(2015, 5, 15),
    maxdate = new Date(2018, 2, 1)
var rawData;
var dict = {};
var sortedCounts = [];
var beforeElectionCount = 0;
var afterElectionCount = 0;
var mediaCount = 0;
var notMediaCount = 0;

/** The X-Axis code for scale and axis */
var xScale = d3.scaleTime()
    .domain([mindate, maxdate])
    .range([paddingSides, width - paddingSides]);
var yScale = d3.scaleTime()
  .domain([midnight, midnight + dayInMill - 1])
  .nice(d3.timeDay, 1)
  .rangeRound([padding, height - paddingBottom]);
function drawLines(svg, height, paddingBottom, xScale, scale) {
  var importantDates = [electionDay, y2016, y2017, y2018]
  var names = ["2016 Presidential Election", "2016", "2017", "2018"]
	var ids = ["#inaug","#election","#campaign","#y16", "#y17", "#y18"]
  importantDates.forEach(function(d, i){
    var isNotYear = isNaN(names[i]);
		var isElect = (names[i].includes("Election"));

    svg.append("text")
    .attr("x", xScale(d))
    .attr("y", height - paddingBottom)
		.attr("id",(isElect? "#election" : void(0)))
		.attr("text-anchor", "middle")
		.attr("font-weight", 800)
    .attr("font-size", (isNotYear ? 20 : 14) * scale)
    .text(names[i])
    .attr("transform", "translate(" + (isNotYear ? (isElect ? -10 : 60) : (isElect ? 0 : 0))*scale + "," + (isNotYear ? (isElect ? 82 : 60) : (isElect ? 0 : 20))*scale +  ")");
		//condition1 ? (condition2 ? "true true": "true false") : (condition2 ? "false true" : "false false");
  })
}
function drawCircles(svgV, xScale, yScale, data, scale, isMedia){
  data.forEach(function(d){
    //if (!d.is_media && !isSmall) return
    var opacity = 0.6;
    var color = "rgb(208, 211, 212)"
    color = isMedia ? (d.is_media ? "rgb(40, 116, 166)" : color) : "rgb(40, 116, 166)"
		opacity = isMedia ? (d.is_media ? opacity : 0.5) : opacity
    svgV.append("circle")
    .attr("r", 3*scale)
    .attr("opacity", opacity)
    .attr("fill", color)
    .attr("cx", xScale(d.created_at))
    .attr("cy", yScale(getTime(d.created_at)))
  })
}
function getTime(date){
   return midnight +
          (date.getHours() * 60 * 60 * 1000) +
          (date.getMinutes() * 60 * 1000) +
          (date.getSeconds() * 1000);
}

d3.queue()
.defer(d3.json, "data.json")
.defer(d3.json, "mediaData.json")
.await(callback);

var mediaData = '[';
var testCount = 0;
function callback(err, data, medData) {
    rawData = data;
    // fix date
    rawData.forEach(function(d, i) {
      var date = d.created_at;
      d.created_at = new Date(date);
      d.is_media = false;
      for (var i = 0; i < media.length; i++) {
        var keyword = media[i];
  			lowercased_text = d.text.toLowerCase();
        if(lowercased_text.includes(keyword)){
          d.is_media = true;
  				mediaData += JSON.stringify(d) + ', ';
  				testCount++;
          break;
        }
      }
  		if (d.is_media == true) {
  			mediaCount++;
  		} else {
  			notMediaCount++;
  		}
    })
    console.log(rawData.filter((d)=>{return d.is_media}).length)

    /**** build area graph data ***/

    mediaData = medData;

    mediaData.forEach(function(d, i) {
      var date = d.created_at; // fix date format
      d.created_at = new Date(date);

      d.outlet = [];
      var outlet = d.outlet;

      // outlet
      var tweet = d.text.toLowerCase();
      var news_outlet;
      if (tweet.includes("cnn")) { // CNN
        cnnCount++;
        outlet.push("cnn");
      }
      if (tweet.includes("nbc") || tweet.includes("msnbc")) { //NBC
        nbcCount++;
        outlet.push("nbc");
      }
      if (tweet.includes("washington post") || tweet.includes("washingtonpost") || tweet.includes("wapo")) { // WASHINGTON POST
        wapoCount++;
        outlet.push("washingtonpost");
      }
      if (tweet.includes("nytimes") || tweet.includes("new york times")) { // NYTIMES
        nytCount++;
        outlet.push("nyt");
      }
      if (tweet.includes("fox")) { // FOX
        foxCount++;
        outlet.push("fox");
      }
      if (tweet.includes("breitbart")) { // BREITBART
        breitCount++;
        outlet.push("breitbart");
      }

      if (outlet.length == 0) {
        miscCount++;
        outlet.push("misc");
      }

      d.is_fakeNews = false;

      // fake news or just news
      if (tweet.includes("fake") || tweet.includes("dishonest") || tweet.includes("fake")) { // CNN
        fakeNews++;
        d.is_fakeNews = true;
      } else {
        notFake++;
      }

      // label by month and year
      var m = d.created_at.getMonth();
      var y = d.created_at.getFullYear();
      if (y!=2015) {
        m = m + (12*(y-2015));
      }
    d.month = m - 5;
  })

  outletsByMonth(mediaData); //month_outlet
  fakeness(mediaData); // month_fake
  fakeOutlets(mediaData); //month_fake_outlets
  //notFakeOutlets(mediaData); // month_notfake_outlets
  /*
  var testCount = 0;
  for(var i = 0; i < 12; ++i) {
    console.log(month_fake_outlets[i])
    for(var o = 0; o < 2; ++o) {
      testCount += month_fake_outlets[i][o];
    }
  }
  console.log(testCount);
  console.log(mediaData);*/

  var outletPercentages_month = intoPercentages(month_outlet, 6);
  // console.log(outletPercentages_month)

  var fakeOutletPercentages_month = intoPercentages(month_fake, 2);
  // console.log(fakeOutletPercentages_month)

  var fakeOutletPercentages_month = intoPercentages(month_fake_outlets, 6);
  // console.log(fakeOutletPercentages_month)

  buildScatterplots();
  createGraph(outletPercentages_month)
}

function buildScatterplots(){
  for (var i = 1; i < 3; i++) {
    var vis = d3.select("#div" + i)
    vis.append("svg")
      .attr("id", "graph" + i)
      .attr("width", width)
      .attr("height", height);
    var svg = d3.select("#graph" + i)
    svg.append("rect")
    .attr("width", width)
    .attr("height", height)
    .attr("x", 0)
    .attr("y", 0)
    .attr("fill","rgb(232,245,253)");
    svg.append("line")
      .attr("id", "#electionline")
      .attr("stroke-width", 3)
      .attr("stroke", linecolor)
      .attr("opacity", 0.7)
      .attr("x1", xScale(electionDay))
      .attr("x2", xScale(electionDay))
      .attr("y1", height)
      .attr("y2", 0);
    var xAxis = d3.axisBottom(xScale);
      svg.append("g")
      .attr("class", "xAxis")
      .attr("transform", "translate(0," + (height - paddingBottom) + ")")
      .call(xAxis
        .tickFormat(d3.timeFormat('%b'))
        .tickSize(0))
      .selectAll("text").remove()

    if (i == 1) {
      svg.append("text")
        .text("fox & friends")
        .style("font-size", 12)
        .style("font-style", "italic")
        .attr("x", width - paddingSides)
        .attr("text-bottom", "middle")
        .attr("y", 170);
      svg.append("text")
        .text("timeslot")
        .style("font-size", 12)
        .style("font-style", "italic")
        .attr("x", width - paddingSides + 10)
        .attr("text-bottom", "middle")
        .attr("y", 185);
      var foxStartTime = new Date()
      foxStartTime.setHours(6,0,0)
      var foxEndTime = new Date()
      foxEndTime.setHours(9,0,0)

      svg.append("rect")
        .attr("x", paddingSides)
        .attr("y", yScale(getTime(foxStartTime)))
        .attr("width", width - paddingSides*2)
        .attr("height", (yScale(getTime(foxEndTime)) - yScale(getTime(foxStartTime))))
        .attr("opacity", 0.2)
        .attr("fill", "rgb(72,201,176)")
    }
    svg.append("text")
      .text("time of day tweeted")
      .style("font-size", 16)
      .style("font-family", "Open Sans")
      .style("font-weight", 700)
      .style("letter-spacing", 3)
      .attr("transform", "rotate(-90)")
      .attr("x",-350)
      .attr("y",120);
    var yAxis = d3.axisLeft(yScale);
      svg.append("g")
      .attr("class", "yAxis")
      .style("font-size", 10)
      .style("font-family","Consolas")
      .attr("transform", "translate(" + paddingSides + ", 0)")
      .call(yAxis
        .tickFormat(d3.timeFormat('%I:%M:%p'))
        .tickSize(0)
        .tickPadding(8))
    svg.append("rect")
      .attr("id","electionLabelHighlight")
      .attr("fill", linecolor)
      .attr("stroke", linecolor)
      .attr("stroke-width",3)
      .attr("width", 250)
      .attr("height", 22)
      .attr("opacity", 0.7)
      .attr("x", xScale(electionDay)-131)
      .attr("y", height - paddingBottom + padding);

    drawCircles(svg, xScale, yScale, rawData, 1, i === 2);
    drawLines(svg, height, paddingBottom, xScale, 0.8);

//labels

d3.select("#graph1")
  .append('svg:image')
  .attr('xlink:href', 'twitterlogo.png')
  .attr("x",900)
  .attr("y",20)
  .attr("width",25)
  .attr("height",25);


d3.select("#graph1")
  .append("line")
	.attr("stroke-width", 1)
  .attr("stroke", "black")
  .attr("x1",830)
  .attr("y1", 90)
  .attr("x2",900)
  .attr("y2", 40);

d3.select("#graph1")
  .append("text")
  .text("Tweet")
  .style("font-size", 12)
  .style("font-weight", 100)
  .attr("x",925)
  .attr("y",35);


d3.select("#graph2")
  .append("circle")
  .attr("r", 3)
  .attr("fill", "black")
  .attr("cx",width - paddingSides + 30)
  .attr("cy",275)
  .attr("opacity",0.6)
  .attr("fill","rgb(208, 211, 212)");

  d3.select("#graph2")
    .append("text")
    .attr("id","legend")
    .attr("x", width - paddingSides + 40)
    .attr("y", 280)
    .text("General Tweet")
    .style("font-size", 10)
    .style("font-weight", 100);

d3.select("#graph2")
    .append("circle")
    .attr("r", 3)
    .attr("fill", "black")
    .attr("cx",width - paddingSides + 30)
    .attr("cy",295)
    .attr("opacity",0.6)
    .attr("fill","rgb(40, 116, 166)")

d3.select("#graph2")
    .append("text")
    .attr("x", width - paddingSides + 40)
    .attr("y", 300)
    .text("Tweet referencing Media")
    .style("font-size", 10)
    .style("font-weight", 100);

  }
}
/******************************** END GRAPH 1 ****************************/

var outlets = {"cnn": 0, "nbc":0, "washington post" : 0, "nytimes" : 0, "fox" :0 , "breitbart": 0}

var mediaData;

var cnnCount = 0;
var nbcCount = 0;
var wapoCount = 0;
var nytCount = 0;
var foxCount = 0;
var breitCount = 0;
var miscCount = 0;

var fakeNews = 0;
var notFake = 0;

// organize outlets by month

/* Array Matrix function from : https://stackoverflow.com/questions/7545641/javascript-multidimensional-array

Courtesy of: The Good Parts (O'Reilly, p. 64) */

Array.matrix = function(numrows, numcols, initial) {
    var arr = [];
    for (var i = 0; i < numrows; ++i) {
        var columns = [];
        for (var j = 0; j < numcols; ++j) {
            columns[j] = initial;
        }
        arr[i] = columns;
    }
    return arr;
}

var month_outlet = Array.matrix(33, 7, 0);
var outlets = {"breitbart":0, "washingtonpost":1, "nyt":2, "nbc":3, "cnn":4, "fox":5, "misc":6};

function outletsByMonth(d) { // want to put in mediaData
  d.forEach(function(element) {
    var m = element.month;
    var outlet_l = element.outlet;
    outlet_l.forEach(function(element) {
      var o = outlets[element];
      month_outlet[m][o] += 1;
    })
  })
}

var month_fake = Array.matrix(33, 2, 0);
// fake news vs. news
function fakeness(d) { // want to put in mediaData
  d.forEach(function(element) {
    var m = element.month;
    var f = element.is_fakeNews;

    if (f == true) { // trumps says is fake
      month_fake[m][0] += 1;
    } else {
      month_fake[m][1] += 1;
    }
  })
}

// outlets / fake news
var month_fake_outlets = Array.matrix(33,7,0);
function fakeOutlets(d) {
    d.forEach(function(element) {
      var f = element.is_fakeNews;
      // console.log(f);
      if (f == true) {
        var m = element.month;
        // console.log(m);
        var outlet_l = element.outlet;
        outlet_l.forEach(function(x) {
          var o = outlets[x];
          month_fake_outlets[m][o] += 1;
        })
    }})
}

// not fake
var month_notfake_outlets = Array.matrix(33,7,0);
function notFakeOutlets(d) {
    d.forEach(function(element) {
      var f = element.is_fakeNews;
      // console.log(f);
      if (f == false) {
        var m = element.month;
        // console.log(m);
        var outlet_l = element.outlet;
        outlet_l.forEach(function(x) {
          var o = outlets[x];
          month_notfake_outlets[m][o] += 1;
        })
    }})
}

function intoPercentages(arrayName, slice) { // slice = last index value
  var monthsinPercent = [];
  for (var i = 0; i < 33; ++i) {
    var total = 0;
    m_array = arrayName[i].slice(0,slice);

    for (var ii in m_array) { // we have total of a month
      total += m_array[ii]
    }

    for(var iii in m_array) { // month to percent
      m_array[iii] = m_array[iii] / total
    }
    monthsinPercent.push(m_array);
}
return monthsinPercent;
}

/********************************** GRAPH 2 ******************************/
// draw SVG set-up
var graph2 = d3.select("#div3");
graph2.append("svg")
.attr("id","graph2")
.attr("width", width)
.attr("height", height);
var svg2 = d3.select("#graph2");
svg2.append("rect")
.attr("width", width)
.attr("height", height)
.attr("x", 0)
.attr("y", 0)
.attr("fill","rgb(232,245,253)");

svg2.append("line")
	.attr("id", "#electionline")
	.attr("stroke-width", 3)
  .attr("stroke", linecolor)
	.attr("opacity", 0.7)
  .attr("x1", xScale(new Date(2016, 10, 8)))
  .attr("x2", xScale(new Date(2016, 10, 8)))
  .attr("y1", height)
  .attr("y2", -10);

/** The X-Axis code for scale and axis */
var monthScale = xScale;
var monthAxis = d3.axisBottom(monthScale);
  svg2.append("g")
  .attr("class", "monthAxis")
	.style("font-size", 14)
	.style("font-weight", "bold")
	.style("font-family","Consolas")
  .attr("transform", "translate(0," + (height - paddingBottom) + ")")
  .call(monthAxis
    .tickFormat(d3.timeFormat('%b')));
/** The Y-Axis code for scale and axis */
var percentageScale = d3.scaleLinear()
  .domain([0,1])
  .rangeRound([height - paddingBottom, padding]);
var percentageAxis = d3.axisLeft(percentageScale);
  svg2.append("g")
  .attr("id", "#percentAxis")
	.style("font-size", 10)
	.style("font-family","Consolas")
  .attr("transform", "translate(" + paddingSides + ", 0)")
  .call(percentageAxis
		.tickFormat(d3.format(".0%"))
    .tickSize(0)
    .tickPadding(8));

var area = d3.area()
    .x(function(d, i) { i+=5; return xScale(new Date(Math.floor(2015 + i/12), i%12, 15)) })
    .y0(function(d) { return percentageScale(d[0]); })
    .y1(function(d) { return percentageScale(d[1]); });

function createGraph(data){
  var outletIndex = [0,1,2,3,4,5]
  var stack = d3.stack()
    .keys(outletIndex)
  var z = d3.scaleOrdinal(d3.schemeCategory10);
  z.domain(outletIndex)
  // console.log(z(5));
  var g = svg2.append("g")
  var layer = g.selectAll(".layer")
    .data(stack(data))
    .enter().append("g")
    .attr("class", "layer");

  layer.append("path")
      .attr("class", "area")
      .style("fill", function(d, i) { return z(d.key); })
      .attr("d", area);

//   layer.filter(function(d) { return d[d.length - 1][1] - d[d.length - 1][0] > 0.01; })
//     .append("text")
//       .attr("x", width - 6)
//       .attr("y", function(d) { return yScale((d[d.length - 1][0] + d[d.length - 1][1]) / 2); })
//       .attr("dy", ".35em")
//       .style("font", "10px sans-serif")
//       .style("text-anchor", "end")
//       .text(function(d) { return d.key; });
}

/******************************** END GRAPH 2 ****************************/
/********************************** GRAPH 3 ******************************/
var graph3 = d3.select("#div4");
graph3.append("svg")
.attr("id","graph3")
.attr("width", width)
.attr("height", height);
var svg3 = d3.select("#graph3");
svg3.append("line")
	.attr("id", "#electionline")
	.attr("stroke-width", 3)
  .attr("stroke", linecolor)
	.attr("opacity", 0.7)
  .attr("x1", xScale(new Date(2016, 10, 8)))
  .attr("x2", xScale(new Date(2016, 10, 8)))
  .attr("y1", height)
  .attr("y2", 0);
svg3.append("g")
  .attr("class", "xAxis")
	.style("font-size", 14)
	.style("font-weight", "bold")
	.style("font-family","Consolas")
  .attr("transform", "translate(0," + (height - paddingBottom) + ")")
  .call(monthAxis
    .tickFormat(d3.timeFormat('%b')));
svg3.append("g")
  .attr("id", "#percentAxis")
	.style("font-size", 10)
	.style("font-family","Consolas")
  .attr("transform", "translate(" + paddingSides + ", 0)")
  .call(percentageAxis
    .tickSize(0)
    .tickPadding(8));
/******************************** END GRAPH 3 ****************************/
</script>

<script>
/********************************** GRAPH 4 ******************************/
var graph4 = d3.select("#div5");
graph4.append("svg")
.attr("id","graph4")
.attr("width", width)
.attr("height", height);
/******************************** END GRAPH 4 ****************************/
function createSmallGraphs(){
  var lowercased = rawData.map(function(d){
    d.text = d.text.toLowerCase()
    return d;
  })
  var filtered = []
  for (var i = 0; i < keywords.length; i++) {
    var regex = new RegExp(keywords[i]);
    var filter = lowercased.filter(function(d) {
      return regex.test(d.text)
    })
    var before = 0;
    var after = 0;
    filtered.push(filter)
    // filtered.push([keywords[i], before*1.0/beforeElectionCount, after*1.0/afterElectionCount])
  }
  console.log(filtered)
  generateGraph(filtered)
}
function generateGraph(arr){
  var lwidth = 950
  var lheight = 475
  var lpadding = 25;
  var lpaddingSides = 50;
  var lpaddingBottom = 100
  arr.forEach(function(data, i) {
    var body = d3.select("body")
    body.append("svg")
    .attr("id", "svg" + i)
    .attr("width", lwidth)
    .attr("height", lheight);
    var svgLoop = d3.select("#svg" + i)
    var xLoopScale = d3.scaleTime()
        .domain([mindate, maxdate])
        .range([lpaddingSides, lwidth - lpaddingSides]);
    var xLoopAxis = d3.axisBottom(xLoopScale);
      svgLoop.append("g")
      .attr("class", "xLoopAxis")
      .attr("transform", "translate(0," + (lheight - lpaddingBottom) + ")")
      .call(xLoopAxis
        .tickFormat(d3.timeFormat('%b'))
        .tickSize(0))
      .selectAll("text").remove()
    var yLoopScale = d3.scaleTime()
      .domain([midnight, midnight + dayInMill - 1])
      .nice(d3.timeDay, 1)
      .rangeRound([lpadding, lheight - lpaddingBottom]);
    var yLoopAxis = d3.axisLeft(yLoopScale);
      svgLoop.append("g")
      .attr("class", "yLoopAxis")
      .attr("transform", "translate(" + lpaddingSides + ", 0)")
      .call(yLoopAxis
        .tickFormat(d3.timeFormat('%H:%M'))
        .tickSize(0)
        .tickPadding(8))
    drawCircles(svgLoop, xLoopScale, yLoopScale, data, .6, true);
    drawLines(svgLoop, lheight, lpaddingBottom, xLoopScale, .5);
    svgLoop.append("text")
    .attr("text-anchor", "middle")
    .attr("x", lwidth/2)
    .attr("y", 10)
    .text(titles[i]);
  })
}
</script>
</div> <!-- end parallelx div-->
</body>
</html>
